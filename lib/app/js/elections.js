PARTIES = {"464" : { "name-en": "Ennahdha", fill: "#183883",logo:"ennahdha.jpg"},
	   "446" : { "name-en": "CPR",    fill: "#4CA42F",logo:"cpr.jpg"},
	   "500" : { "name-en": "Petition", fill: "#158600",logo:"petition.jpg"},
	   "430" : { "name-en": "Ettakatol", fill: "#B22222",logo:"ettakatol.jpeg"},
	   "137" : { "name-en": "PDP",    fill: "#FFD600",logo:"pdp.jpg"},
	   "447" : { "name-en": "Initiative", fill: "#15ADFF",logo:"initiative.jpg"},
	   "256" : { "name-en": "PDM",    fill: "#0557BA"},
	   "401" : { "name-en" : "Afek",   fill: "red",logo:"afek.jpg"},
	   "437" : { "name-en" : "PCOT",   fill: "#D70F0F",logo:"pcot.jpg"},
	   "386" : { "name-en" : "MP",     "longname-fr": "Mouvement du Peuple" , fill: "#FBB03B",logo:"mp.jpg"},
	   "455" : { "name-en" : "PLP",    "longname-fr": "Parti de la Lutte Progressiste", fill: "#B83589",logo:"plp.jpg"},
	   "259" : { "name-en" : "Pole",   "longname-fr": "Pole Democratique Moderniste", fill: "#191919",logo:"pole.jpg"},
	   "382" : { "name-en": "MDS",    "longname-fr": "Mouvement des démocrates socialistes", fill: "green",logo:"mds.jpg"},
	   "355" : { "name-en": "AL",     "longname-fr": "Alwafa Lichouhadaa", fill: "#3c8cc7",logo:"al.jpg"},
           "444" : { "name-en": "PLM",    "longname-fr":"Parti Libéral Maghrébin",fill:"#295c24",logo:"plm.jpg"},
           "435" : { "name-en": "PEE",    "longname-fr":"Parti de l'équité et de l'égalité",fill:"#e5e5e5",logo:"pee.jpg"},
	   "136" : { "name-en": "PND",    "longname-fr":"Neo Destour",fill:"#aa56ff",logo:"pnd.jpg"},
	   "413" : { "name-en": "PDSN",   "longname-fr":"Parti de l'équité et de l'égalité",fill:"#ff56aa"},
	   "410" : { "name-en": "PNCU",   "longname-fr":"Parti de la nation culturel et unioniste",fill:"#75e19c",logo:"pncu.jpg"},
	   "394" : { "name-en": "MOUPAD", "longname-fr":"Mouvement des patriotes démocrates", fill:"#ffaad4", logo:"moupad.jpg"},
	   "387" : {"name-en": "MPUP",    "longname-fr":"Mouvement du peuple unioniste progressiste", fill:"#8e4835",logo:"mpup.jpg"},
	   "566" : {"name-en":"FNT",      "longname-fr":"Front National Tunisien", fill:"#ac103b",logo:"fnt.jpg"},
	   "330" : {"name-en":"UDC","longname-fr":"Union des Diplomes Chommeurs", fill:"#2b2f86",logo:"udc.jpg"}, //la liste est rattache au UDC d'ou le shortcut pour le nom
	   "64"  : {"name-en":"LE", "longname-fr" :"Liste de l'espoir", fill:"#ffe4c2",logo:"le.jpg" },
	   "506" : {"name-en":"VL", "longname-fr":"Sawt El Moustakel", fill:"#efe9aa",logo:"vl.jpg"},
}

CIRCONSCRIPTIONS = {
 "111": {
     "name": "Tunis 1",
     "shp": "tunis1",
     "delegations":["62","54","68","52","66","65","63","64","61","53","67"],
 },
 "112": {
     "name": "Tunis 2",
     "shp": "tunis2",
     "delegations":["60","57","51","70","55","56","59","58","69","71"],
 },
 "120": {
     "name": "Ariana",
     "shp": "ariana",
     "delegations":["51","56","54","57","55","52","53"],
 },
 "130": {
     "name": "Ben Arous",
     "shp": "benarous",
     "delegations":["51","56","53","52","61","57","54","59","60","55","62","58"],
 },
 "140": {
     "name": "Manubah",
     "shp": "manubah",
     "delegations":["51","52","55","53","58","56","54","57"],
 },
 "151": {
     "name": "Nabel 1",
     "shp": "nabeul1",
     "delegations":["59","55","52","51","56","53","58","57","54"],
 },
"152": {
     "name": "Nabel 2",
    "shp": "nabeul2",
     "delegations":["60","62","63","65","64","66","61"],
 },
 "160": {
     "name": "Zaghouan",
     "shp": "zaghouane",
     "delegations":["52","53","54","51","55","56"],
 },
 "170": {
     "name": "Bizerte",
     "shp": "bizerte",
     "delegations":["63","59","57","53","54","51","61","55","56","58","60","62","64"],
 },
 "210": {
     "name": "Beja",
     "shp": "beja",
     "delegations":["54","53","52","55","51","58","59","56","57"],
 },
 "220": {
     "name": "Jendouba",
     "shp": "jendouba",
     "delegations":["55","53","57","54","58","51","59","56","52"],
 },
 "230": {
     "name": "Le Kef",
     "shp": "lekef",
     "delegations":["57","60","61","58","56","52","51","59","53","54","55"],
 },
 "240": {
     "name": "Siliana",
     "shp": "siliana",
     "delegations":["58","51","52","59","61","57","60","53","56","55","54"],
 },
 "310": {
     "name": "Sousse",
     "shp": "sousse",
     "delegations":["52","66","61","60","54","56","51","55","65","59","53","57","62","64","58","63"],
 },
 "320": {
     "name": "Monastir",
     "shp": "monastir",
     "delegations":["51","53","63","60","55","62","52","59","57","56","61","54","58"],
 },
 "330": {
     "name": "Mahdia",
     "shp": "mahdia",
     "delegations":["58","61","53","52","54","57","55","51","59","60","56"],
 },
 "341": {
     "name": "Sfax 1",
     "shp": "sfax1",
     "delegations":["66","54","53","60","61","63","59","58"],
 },
 "342": {
     "name": "Sfax 2",
     "shp": "sfax2",
     "delegations":["52","64","65","57","62","51","55"],
 },
 "410": {
     "name": "Kairouan",
     "shp": "kairouan",
     "delegations":["58","52","61","56","57","51","53","60","59","55","54"],
 },
 "420": {
     "name": "Kasserine",
     "shp": "kasserine",
     "delegations":["61","63","53","54","58","62","60","57","52","55","56","59","51"],
 },
 "430": {
     "name": "Sidi Bou Zid",
     "shp": "sidibouzid",
     "delegations":["60","56","53","58","57","62","61","54","55","52","51","59"],
 },
 "510": {
     "name": "Gabes",
     "shp": "gabes",
     "delegations":["60","51","52","59","53","54","57","58","56","55"],
 },
 "520": {
     "name": "Medenine",
     "shp": "medenine",
     "delegations":["57","56","51","59","55","52","53","54","58"],
 },
 "530": {
     "name": "Tataouine",
     "shp": "tataouine",
     "delegations":["55","52","54","56","57","51","53"],
 },
 "610": {
     "name": "Gafsa",
     "shp": "gafsa",
     "delegations":["57","55","60","51","54","59","53","58","56","61","52"],
 },
 "620": {
     "name": "Tozeur",
     "shp": "tozeur",
     "delegations":["55","54","53","51","52"],
 },
 "630": {
     "name": "Kebili",
     "shp": "kebili",
     "delegations":["55","54","54","52","56","51","53"],
 }
}

var data,elus;
var selectedParty,selectedCirconscription;
var navigationButton = d3.select("#navigationButton")
    .on('click',function(){
	if (selectedParty) { 
	    selectParty();
	}else if(selectedCirconscription) {
	    selectCirconscription();
	}
    });
var tooltipInstruction = d3.select("#tooltipInstruction");

var width = $("#map-circonscriptions").width(),
    height = width * 2.3,
    tooltip = d3.select("#tooltip"),
    formatNumber = d3.format(",d");

var svg = d3.select("#map-circonscriptions")
    .append("svg:svg")
    .attr("class", "RdPu")
    .attr("height", height)
    .attr("width", width);


var svgG = svg.append("svg:g");

svgG.attr("class","circonscriptionName")
    .attr("transform","translate(0,25)")
    .append("svg:text")
    .attr("class","circonscription")
    .text("");



load(svgG, width, height);

function load(svg, width, height) {

    d3.json("data/geojson/circonscriptions.json", function(json) {
	data = json;
        getCirconscriptionData(json, function(geojson){
	    var path = getProjectionPath(geojson, width, height);
	    updateMap(svg, geojson, path);
	    d3.json("data/results/elus.json", function(elusJson) {
		data.elus = elusJson.elected;
		updateInfoBox();
	    });    
	});

	function xjson(circonscriptionId, callback) {
           d3.json("data/results/elus/"+circonscriptionId+ ".json", function(eJson) {
	       d3.json("data/results/agg/"+circonscriptionId+ ".json", function(aJson) {
		   eJson && aJson ? callback(null, { elus : eJson, agg : aJson, code : eJson.circonscription.code}) : callback("error", null);
	       })
	   });
	}

        function getCirconscriptionData(geojson,callback){
	    var q = queue(1);
	    geojson.features
	       .forEach(function(feat){
		   var code = feat.properties.code_circo;
		   q.defer(xjson,code)
                   
	       });
	    q.await(function(error, results) { 
		var circos = results.map(function(_){return _.code});
		geojson.features
		    .forEach(function(feat){
			var code = feat.properties.code_circo;
			var i = circos.indexOf(code);
			if(i > -1){
			    feat.id = id(feat);
			    feat.properties.elus = results[i].elus;
			    feat.properties.agg = results[i].agg;
			}
		    });
		callback(geojson);
	    });
	    
	}
	
    })
    
    function updateInfoBox() {
	function getInfoBoxHeader(){
	    return selectedParty ? ['DIVISION','PERCENTAGE','VOTES'] : ['PARTY','PERCENTAGE','VOTES','SEATS'];
	}
	
	var table = d3.select("#info-table");

	var head = table.select("thead")
	    .select('tr')
	    .selectAll('th')
	    .data(getInfoBoxHeader());
		
	head.enter()
	    .append('th')
	    .text(function(_){return _});

	head.exit().remove();

	var infoData;

	if (selectedParty){
	    infoData = data.features.map(function(feat){return getPartyResult(feat,selectedParty)});
	} else {
	    if (selectedCirconscription){
		
	    }else{
		infoData = data.elus;
	    }
	    
	    var tr = table.select("tbody")
		.selectAll("tr")
		.data(data.elus);

	    tr.enter()
		.append("tr") ;
	
	    var party = tr.append("td")
		.classed("leftish",true);
		
	    party.append("div")
		.style("background-color",function(_){return PARTIES[_.id] ? PARTIES[_.id].fill : "grey"})
		.classed("partyColoredBoxBig",true);
		
	    var partyLink =	party.append("div")
		.classed("party",true)
		.append("div")
		.classed("partyLink",true);
	    
            partyLink.text(function(_){
		return PARTIES[_.id] ? PARTIES[_.id]['name-en'] :_.name;
	    });
	    
	    partyLink.filter(function(_){
		return (PARTIES[_.id] && PARTIES[_.id].logo);
	    })
		.append('img')
		.classed('partyLogo',true)
		.attr('src',function(_){
		    return "data/parties/" + PARTIES[_.id].logo;
		})
		.attr('width','41')
		.attr('height','30');
	    
	    party.on('click',function(_){selectParty(_.id);})
		.on('dblclick',function(_){selectParty(_.id);});
	    
	    tr.append('td')
		.text(function(_){return Math.floor(_.pourcentage * 100) / 100 +"%"; } )
		.classed("percentageBig",true);
	    
	    tr.append("td")
		.text(function(_){
		    return formatNumber(_.vote);
		});
	    tr.append("td")
		.append('span')
	    .classed('badge',true)
		.classed('badge-inverse',true)
		.style("background-color",function(_){return PARTIES[_.id] ? PARTIES[_.id].fill : "grey"})
		.text(function(_){return _.elus.length;});
	    
	    tr.sort(function(a,b) {
		return parseInt(b.elus.length) - parseInt(a.elus.length);
	    } )
	    tr.exit().remove();
	}
    }    
}

function delegationModeActive(d){
    return  selectedCirconscription && (typeof d.properties.agg !== "undefined");
}


function mouseover2(d,i){
    mouseover(d,i);
    tooltip.style("visibility", "visible");
    var tbl = tooltip.select('table');
    var header = d3.select('#tooltip').select('thead').selectAll('td');
    header.selectAll('p').remove();
    header.append('p')
	.classed('tooltipTitle',true)
	.text( selectedCirconscription &&  d.properties.name_2? d.properties.name_2 : d.properties.name_1);
    d3.select(this).style('cursor', selectedCirconscription &&  d.properties.name_2 ? 'auto' : null);
    tooltipInstruction.style('display',  selectedCirconscription &&  d.properties.name_2 ? 'none' : null);
   
    tbl.select('tbody').remove();
    var tooltipData = delegationModeActive(d) ? d.properties.agg.resultat.listes.filter(function(d,i){return i < 5;}) : d.properties.elus.listes;
    if (selectedCirconscription){
	tooltipData = delegationModeActive(d) ? d.properties.agg.resultat.listes.filter(function(d,i){return i < 5;}) : [];
    } else {
	tooltipData = d.properties.elus.listes;
    }
    if (selectedParty){ 
	var partyResult = getPartyResult(d,selectedParty);
	tooltipData = [partyResult];
    }
    
    var trEnter = tbl.append('tbody')
	.selectAll("tr")
	.data(tooltipData);
    
    var tr = trEnter.enter()
	.append("tr");
    
    tr.append("td")
	.classed("leftish",true)
	.text(function(_){
	    return PARTIES[_.id] ? PARTIES[_.id]['name-en'] :"other";
	})
	.append("div")
	.style("background-color",function(_){return PARTIES[_.id] ? PARTIES[_.id].fill : "grey"})
	.classed("partyColoredBox",true);
    tr.append('td')
	.text(function(_){
	    var percent = _.pourentage || _.pourcentage; 
		return Math.floor(percent * 100) / 100 +"%"; 
	})
	.classed("percentage",true);
    tr.append("td")
	.text(function(_){return formatNumber(_.vote);});
    tr.filter(function(_){return _.elus;}).append("td")
	    .append('span')
	.classed('badge',true)
        .classed('badge-inverse',true)
	.style("background-color",function(_){return PARTIES[_.id] ? PARTIES[_.id].fill : "grey"})
	.text(function(_){return _.elus.length;});
    trEnter.order();

}

function mouseout2(d,i){
    mouseout(d,i);
    tooltip.style("visibility", "hidden");
}

function mousemove(d,i){
    tooltip.style("top", (d3.event.pageY+10)+"px") 
	.style("left",(d3.event.pageX+15)+"px"); //d3.event instead of event which does not work on firefox
}

function refreshMapAndLegend(){
    Elec.colorMapAndLegend(selectedParty);
}

function id(d){
    return "c" + d.properties.code_circo + (typeof d.properties.code_deleg !== "undefined" ? "d" + d.properties.code_deleg :"");
}

function updateMap(svg, json, path) {
    var features = svg.selectAll("path")
        .data(json.features, id);
    
    features
        .enter()
        .append("svg:path");
    
    features
        .attr("id", id)
        .attr("d", path)
        .on("mouseover", mouseover2)
	.on("mouseout", mouseout2)
	.on("mousemove", mousemove)
	.on('click', function(d){selectCirconscription(d.properties.code_circo);});
    
    features.exit().remove(); 
    refreshMapAndLegend();
}

function fetchDelegationData(circonscriptionId, delegationId, callback) {
    d3.json("data/results/agg/"+circonscriptionId+ "/" + delegationId + ".json", function(delegationData) {
	delegationData ? callback(null, { agg : delegationData, delegationId : delegationId}) : callback("error", null);
    });
}

function fetchAllDelegationsPerCirconscription(geojson, callback){
    var q = queue(1);
    var circonscriptionId = geojson.features[0].properties.code_circo; 
    CIRCONSCRIPTIONS[circonscriptionId].delegations
	.forEach(function(delegationId){
	    q.defer(fetchDelegationData, circonscriptionId, delegationId) 
	});

    q.await(function(error, results) { 
	var delegations = results.map(function(_){return _.delegationId});
	geojson.features
	    .forEach(function(feat){

		var code = feat.properties.code_deleg;
		var i = delegations.indexOf(code);
		if(i > -1){
		    feat.id = id(feat);
		    feat.properties.agg = results[i].agg;
		}
	    });
	callback(geojson);
    });
}


function selectCirconscription(id){
    var previousCirconscription = selectedCirconscription;
    if (previousCirconscription) data.features = data.features.filter(function(d){return (typeof d.properties.code_deleg === "undefined" && typeof d.properties.name_2 === "undefined")});
    
    selectedCirconscription = id;
    
    navigationButton.text(selectedParty ? "back to circonscription results" : "back to all parties results")
	.style('display', selectedParty || selectedCirconscription ? 'inline-block' : null);
    
    if (selectedCirconscription) {	
	d3.json('data/geojson/'+CIRCONSCRIPTIONS[selectedCirconscription].shp+'.json',function(circoGeojson){
	    //FIXME: get the election data per circo here
	    
	    circoGeojson.features.forEach(function(d){d.properties.code_circo = selectedCirconscription}); //FIXME: on the geojson
	    var circoPath = getProjectionPath(circoGeojson, width, height);
	    fetchAllDelegationsPerCirconscription(circoGeojson,function(geojson){
		data.features.push.apply(data.features,geojson.features);
		updateMap(svgG, data, circoPath);
	    })
	});
    }else {
	var globalPath = getProjectionPath(data, width, height);
	updateMap(svg, data, globalPath);
    }
}

function selectParty(id){
    selectedParty = (id && PARTIES[id]) ? id : null;
    navigationButton.text( selectedCirconscription ? "back to circonscription results" : "back to all parties results")
	.style('display', selectedParty || selectedCirconscription ? 'inline-block' : null);
    refreshMapAndLegend();
}

function getPartyResult(feature,id){
    if (typeof feature.properties.agg === "undefined") return;
    var l = feature.properties.agg.resultat.listes; //feature.properties.elus.listes;
    var i = l.map(function(_){return _.id}).indexOf(id);
    if (i == -1){
	l = feature.properties.agg.resultat.listes;
	i = l.map(function(_){return _.id}).indexOf(+id);
    }
    if (i > -1) return l[i];
}

var ELEC = (function() {
    var minValue=0, maxValue=60,  legend, legendGradient, legendTicks,continuousScale;
    var legendGradientWidth = 15;
    var legendGradientHeight = 200;
    var extraTranslateRight =30;

    var hue = d3.hsl(PARTIES[355].fill).h;
    var svg = d3.select('#map-circonscriptions').select('svg');
    
    legend = svg.append('svg:g').attr('transform', 'translate(' + (0 + extraTranslateRight) + ', 640)');
    legendGradient = legend.append('svg:g');
    legendTicks = legend.append('svg:g');
    continuousScale = d3.scale.linear().domain([minValue, maxValue]).range([0, 1]);

    this.colorMapAndLegend = function(id){
	eraseLegend();
	drawLegend(id);
	colorMap(id);
    }
    function convertPercentToColor(id, percent) {
	return d3.hsl( getPartyHue(id), 1, 1 - continuousScale(percent));
    }

    function getPartyHue(id){
	return d3.hsl(PARTIES[id].fill).h;
    }

    
    function colorMap(){
	//FIXME: merge the 2 if branches (put them inside the fill option)
	if (selectedParty){
	    svg.selectAll('path').style('fill',function(d){
		if (selectedCirconscription && typeof d.properties.code_deleg === "undefined") return;
		var result = getPartyResult(d,selectedParty);
		if (!result) return;
		var percent = result.pourcentage || result.pourentage; //FIXME: on the api side /elus
		return convertPercentToColor(selectedParty,percent);
	    })
	} else {
	    svg.selectAll("path")
	    .style("fill",function(d) {
		if (selectedCirconscription && typeof d.properties.code_deleg === "undefined") return;
		var first = d.properties.agg ? d.properties.agg.resultat.listes[0]: null;
		w = first ?  PARTIES[first.id] : null;
		return w ? w.fill : null;
	    });
	}
    }

    function eraseLegend() {
	legend.selectAll('text').remove();
	legend.selectAll('rect').remove(); //for the border
	legendGradient.selectAll('rect').remove();
	legendTicks.selectAll('text').remove();
    }
    function drawLegend(id) {
	if (!id) return;

	legend.append('svg:text')
		.attr('class', 'legend-title')
		.attr('x', -30)
		.attr('y', -20)
		.text('percent');

	// create the color gradient
	legendGradient.selectAll('rect')
		.data(d3.range(0, 1, 0.01))
		.enter()
		.insert('svg:rect')
		.attr('x', 1)
		.attr('y', function (d, i) {
			return i * 2;
		})
		.attr('width', legendGradientWidth)
		.attr('height', 2)
		.style('fill', function (d, i) {
			return d3.hsl(getPartyHue(id), 1, d);
		});

	legendTicks.selectAll('text')
		.data([maxValue, minValue])
		.enter()
		.insert('svg:text')
		.attr('class', 'legend-tick')
		.attr('text-anchor', 'end')
		.attr('x', 0)
		.attr('y', function (d, i) {
			return i * legendGradientHeight + 5;
		})
		.text(function(d, i) {
			return d3.format('.0f')(d) + '%';
		});

	// this is a dumb way of creating a border!
	legend.append('svg:rect')
		.attr('y', 0)
		.attr('x', 1)
		.attr('width', legendGradientWidth)
		.attr('height', legendGradientHeight)
		.style('fill', 'none')
		.style('stroke', '#ccc')
		.style('shape-rendering', 'crispEdges');
    }

})

var Elec = new ELEC();
